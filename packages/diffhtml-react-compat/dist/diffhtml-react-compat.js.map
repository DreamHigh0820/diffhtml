{"version":3,"file":"diffhtml-react-compat.js","sources":["../src/index.js"],"sourcesContent":["const { createTree, innerHTML, outerHTML, use, html } = require('diffhtml');\nconst syntheticEvents = require('diffhtml-synthetic-events');\nconst { assign, freeze, keys } = Object;\n\nlet NodeCache = null;\nlet ComponentCache = new Map();\nlet reactFlow = [];\n\nconst reconcileComponents = (oldTree, newTree) => {\n  // Stateful components have a very limited API, designed to be fully\n  // implemented by a higher-level abstraction. The only method ever called\n  // is `render`. It is up to a higher level abstraction on how to handle the\n  // changes.\n  for (let i = 0; i < newTree.childNodes.length; i++) {\n    const oldChild = oldTree && oldTree.childNodes[i];\n    const newChild = newTree.childNodes[i];\n\n    // If no new child return.\n    if (!newChild) {\n      newTree.childNodes.splice(i, 1);\n      i--;\n      continue;\n    }\n\n    // If incoming tree is a component, flatten down to tree for now.\n    if (newChild && typeof newChild.rawNodeName === 'function') {\n      const oldChildNodes = oldTree && oldTree.childNodes;\n      const oldCtor = oldChild && oldChild.rawNodeName;\n      const newCtor = newChild.rawNodeName;\n      const children = newChild.childNodes.length ? newChild.childNodes.filter(Boolean) : null;\n      const props = assign({}, newChild.attributes, { children });\n      const canNew = newCtor.prototype && newCtor.prototype.render;\n\n      // If the component has already been initialized, we can reuse it.\n      const oldInstance = oldCtor === newCtor && ComponentCache.get(oldChild);\n      const newInstance = !oldInstance && canNew && new newCtor(props);\n      const instance = oldInstance || newInstance;\n\n      // See if we should update.\n      const shouldUpdate = instance && instance.shouldComponentUpdate(\n        instance.props, instance.state\n      );\n\n      const renderTree = createTree(\n        instance ? (shouldUpdate ? instance.render(props, instance.state) : ComponentCache.get(instance)) : newCtor(props)\n      );\n\n      console.log(renderTree && renderTree.nodeName);\n\n      if (!renderTree) { continue; }\n\n      renderTree.rawNodeName = newCtor;\n\n      // Remove any missing children.\n      renderTree.childNodes = renderTree.childNodes.filter(Boolean);\n\n      // Build a new tree from the render, and use this as the current tree.\n      newTree.childNodes[i] = renderTree;\n\n      // Cache this new current tree in both directions.\n      if (instance) {\n        ComponentCache.set(instance, renderTree);\n        ComponentCache.set(renderTree, instance);\n      }\n\n      // Recursively update trees.\n      reconcileComponents(oldChild, renderTree);\n    }\n    else if (newChild) {\n      reconcileComponents(oldChild, newChild);\n    }\n  }\n};\n\nfunction reactCompatibility(options = {}) {\n  const startReconcileComponents = transaction => {\n    reconcileComponents(transaction.state.oldTree, transaction.newTree);\n  };\n\n  let diffHTMLTasks = null;\n\n  function reactCompatibilityTask(transaction) {\n    // Use React Flow.\n    const { tasks } = transaction;\n    const index = tasks.indexOf(diffHTMLTasks.reconcileTrees);\n\n    // Inject after tree reconcilation.\n    transaction.tasks = tasks.splice(index + 1, 0, startReconcileComponents);\n\n    return () => {\n      ComponentCache.forEach((key, value) => {\n        value.componentDidMount && value.componentDidMount();\n        value.componentDidUpdate && value.componentDidUpdate(value.props, value.state);\n      });\n    };\n  }\n\n  const subscribe = ({ internals, tasks }) => {\n    diffHTMLTasks = tasks;\n    NodeCache = internals.NodeCache;\n  };\n\n  return assign(reactCompatibilityTask, { subscribe });\n}\n\nuse(reactCompatibility());\nuse(syntheticEvents());\n\nexports.createElement = (...args) => {\n  const tree = createTree(...args);\n\n  tree.$$typeof = Symbol.for('react.element');\n\n  const attributes = keys(tree.attributes);\n\n  if (attributes.includes('className')) {\n    tree.attributes.class = tree.attributes.className;\n  }\n\n  attributes.forEach(name => {\n    if (name.indexOf('on') === 0) {\n      tree.attributes[name.toLowerCase()] = tree.attributes[name];\n    }\n  });\n\n  return tree;\n};\n\nexports.Component = class Component {\n  constructor(props) {\n    const { constructor } = this;\n    const { defaultProps = {}, propTypes = {} } = constructor;\n\n    this.props = assign({}, props);\n    this.state = {};\n\n    Object.keys(defaultProps).forEach(prop => {\n      if (this.props[prop] === undefined) {\n        this.props[prop] = defaultProps[prop];\n      }\n    });\n\n    if (process.env.NODE_ENV !== 'production') {\n      Object.keys(propTypes).forEach(prop => {\n        const err = propTypes[prop](this.props, prop, constructor.name, 'prop');\n        if (err) { throw err; }\n      });\n    }\n  }\n\n  setState(newState) {\n    this.state = freeze(assign({}, this.state, newState));\n\n    if (this.shouldComponentUpdate()) {\n      outerHTML(\n        NodeCache.get(ComponentCache.get(this)),\n        this.render(this.props, this.state),\n        {\n          flow: reactFlow,\n        }\n      );\n    }\n  }\n\n  shouldComponentUpdate() {\n    return true;\n  }\n\n  componentWillUnmount() {}\n};\n\nexports.PropTypes = require('proptypes');\nexports.html = html;\nexports.render = (component, mount) => innerHTML(mount, component, );\nexports.isValidElement = function(object) {\n  return (\n    typeof object === 'object' &&\n    object !== null &&\n    object.$$typeof === Symbol.for('react.element')\n  );\n};\n"],"names":["require","createTree","innerHTML","outerHTML","use","html","syntheticEvents","assign","Object","freeze","keys","NodeCache","ComponentCache","Map","reactFlow","reconcileComponents","oldTree","newTree","i","childNodes","length","oldChild","newChild","splice","rawNodeName","oldChildNodes","oldCtor","newCtor","children","filter","Boolean","props","attributes","canNew","prototype","render","oldInstance","get","newInstance","instance","shouldUpdate","shouldComponentUpdate","state","renderTree","log","nodeName","set","reactCompatibility","options","startReconcileComponents","transaction","diffHTMLTasks","reactCompatibilityTask","tasks","index","indexOf","reconcileTrees","forEach","key","value","componentDidMount","componentDidUpdate","subscribe","internals","exports","createElement","tree","$$typeof","Symbol","for","includes","class","className","name","toLowerCase","Component","constructor","defaultProps","propTypes","prop","undefined","newState","PropTypes","component","mount","isValidElement","object"],"mappings":"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"}